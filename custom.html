<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>自定义词库管理</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css" />
  
</head>
<body>
  <div class="bg-blob blob-1"></div>
  <div class="bg-blob blob-2"></div>
  <div class="bg-blob blob-3"></div>

  <div class="shell">
    <h1>自定义词库</h1>
    <p class="subtitle">填入要参与押韵的自定义词或单字，空格/，/换行分隔。会保存在浏览器本地并被主页自动加载。</p>

    <textarea id="input" placeholder="示例：北京 程序员 飞"></textarea>
    <div class="hint">添加规则：多字词会被拆成单字参与押韵；保存后数据存入 localStorage（不会上传）。</div>

    <div class="controls">
      <button class="btn" id="save" type="button" onclick="handleSave()">保存到浏览器</button>
      <button class="btn ghost" id="clear" type="button" onclick="handleClear()">清空自定义</button>
      <button class="btn ghost" id="back" type="button" onclick="location.href='index.html'">返回生成器</button>
      <button class="btn ghost" id="export" type="button" onclick="handleExport()">导出到剪切板</button>
      <button class="btn ghost" id="import" type="button" onclick="handleImport()">从剪切板导入</button>
    </div>

    <div class="list" id="current"></div>
    <div class="export-box" id="exportBox" style="display:none;"></div>
    <div class="hint" id="status"></div>

    <div class="footer">存储键：CUSTOM_RHYME_BANK。主页会读取并合并至字库。</div>
  </div>

  <script>
    const STORAGE_KEY = 'CUSTOM_RHYME_BANK';
    let memoryStore = [];

    const status = (msg) => {
      document.getElementById('status').textContent = msg;
      console.log('[custom]', msg);
    };

    const storageAvailable = () => {
      try {
        const t = '__TEST__';
        localStorage.setItem(t, '1');
        localStorage.removeItem(t);
        return true;
      } catch (e) {
        return false;
      }
    };

    const parseInput = (text) => {
      return text
        .replace(/[，,；;、\n\r\t]+/g, ' ')
        .split(' ')
        .map((s) => s.trim())
        .filter(Boolean);
    };

    const loadList = () => {
      if (!storageAvailable()) return [...memoryStore];
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        const arr = JSON.parse(raw);
        if (!Array.isArray(arr)) return [];
        // 过滤掉无效词条（旧版本可能误存入的代码片段）
        const invalidPatterns = /^(\/\/|const|customBank|data\.js|追加到|中的|\[|\]|\{|\}|=|;|'|"|`)/;
        return arr.filter(w => {
          if (!w || typeof w !== 'string') return false;
          const trimmed = w.trim();
          if (!trimmed) return false;
          if (invalidPatterns.test(trimmed)) return false;
          return true;
        });
      } catch (e) {
        status('读取 localStorage 失败，改用内存存储。');
        return [...memoryStore];
      }
    };

    const saveList = (list) => {
      const uniq = Array.from(new Set(list));
      if (!storageAvailable()) {
        memoryStore = uniq;
        status('当前环境不可写入 localStorage，已暂存于内存（刷新后会丢失）');
        return uniq;
      }
      localStorage.setItem(STORAGE_KEY, JSON.stringify(uniq));
      status('已写入 localStorage');
      return uniq;
    };

    const renderList = () => {
      const box = document.getElementById('current');
      const list = loadList();
      if (!list.length) {
        box.textContent = '当前无自定义词';
        return;
      }
      box.innerHTML = '';
      list.forEach((w) => {
        const span = document.createElement('span');
        span.className = 'pill';
        span.textContent = w;
        box.appendChild(span);
      });
    };

    function handleSave() {
      console.log('保存按钮被点击');
      const text = document.getElementById('input').value;
      const parts = parseInput(text);
      if (!parts.length) {
        showToast('请输入至少一个词/字');
        return;
      }
      saveList(parts.concat(loadList()));
      document.getElementById('input').value = '';
      renderList();
      alert('已保存 ' + parts.length + ' 个词到浏览器');
    }

    function handleClear() {
      const list = loadList();
      if (!list.length) {
        alert('当前无自定义词');
        return;
      }
      if (!confirm('确认清空自定义词库？')) return;
      if (storageAvailable()) localStorage.removeItem(STORAGE_KEY);
      memoryStore = [];
      renderList();
      status('已清空');
    }

    function handleExport() {
      const list = loadList();
      const box = document.getElementById('exportBox');
      if (!list.length) {
        box.style.display = 'block';
        box.textContent = '当前无自定义词可导出。';
        alert('当前无自定义词可导出');
        return;
      }
      // 用换行分隔导出
      const exportText = list.join('\n');
      navigator.clipboard.writeText(exportText).then(() => {
        box.style.display = 'block';
        box.textContent = '已复制到剪切板：' + list.join('、');
        alert('已导出 ' + list.length + ' 个词到剪切板');
      });
    }

    function handleImport() {
      const inputBox = document.getElementById('input');
      navigator.clipboard.readText().then(clipText => {
        if (clipText && clipText.trim()) {
          inputBox.value = clipText;
          inputBox.focus();
          alert('已粘贴到输入框，点击"保存到浏览器"确认');
        } else {
          alert('剪切板为空');
        }
      });
    }

    const init = () => {
      try {
        console.log('开始初始化');
        renderList();
        status(storageAvailable() ? 'localStorage 可用，数据会持久保存于浏览器' : 'localStorage 不可用，将使用内存存储，刷新后会丢失');
        console.log('初始化完成');
      } catch (e) {
        alert('初始化失败，请查看控制台');
        console.error('初始化错误:', e);
      }
    };

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
  <script src="data.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script>
    // GSAP Animations
    document.addEventListener("DOMContentLoaded", () => {
      gsap.config({ nullTargetWarn: false });

      // 1. Background Blobs Floating
      gsap.to(".blob-1", {
        x: "20%", y: "20%", duration: 8, repeat: -1, yoyo: true, ease: "sine.inOut"
      });
      gsap.to(".blob-2", {
        x: "-20%", y: "-20%", duration: 10, repeat: -1, yoyo: true, ease: "sine.inOut", delay: 1
      });
      gsap.to(".blob-3", {
        x: "15%", y: "-15%", scale: 1.2, duration: 12, repeat: -1, yoyo: true, ease: "sine.inOut", delay: 2
      });

      // 2. Entry Animations
      const tl = gsap.timeline({ defaults: { ease: "power3.out" } });

      tl.from(".shell", {
        y: 30,
        opacity: 0,
        duration: 1.2,
        clearProps: "all"
      })
      .from("h1", {
        y: 20,
        opacity: 0,
        duration: 0.8
      }, "-=0.8")
      .from(".subtitle", {
        y: 10,
        opacity: 0,
        duration: 0.8
      }, "-=0.6")
      .from("textarea", {
        y: 20,
        opacity: 0,
        duration: 0.8
      }, "-=0.6")
      .from(".btn", {
        y: 20,
        opacity: 0,
        duration: 0.6,
        stagger: 0.1
      }, "-=0.6")
      .from(".list", { // Fixed selector from #list to .list
        opacity: 0,
        y: 20,
        duration: 0.8
      }, "-=0.4");

      // 3. Interactive Elements
      const buttons = document.querySelectorAll(".btn");
      buttons.forEach(btn => {
        btn.addEventListener("mouseenter", () => {
          gsap.to(btn, { scale: 1.05, duration: 0.3, ease: "back.out(1.7)" });
        });
        btn.addEventListener("mouseleave", () => {
          gsap.to(btn, { scale: 1, duration: 0.3, ease: "power2.out" });
        });
        btn.addEventListener("mousedown", () => {
          gsap.to(btn, { scale: 0.92, duration: 0.1, ease: "power1.out" });
        });
        btn.addEventListener("mouseup", () => {
          gsap.to(btn, { scale: 1.05, duration: 0.4, ease: "elastic.out(1, 0.3)" });
        });
      });
    });
  </script>
</body>
</html>
