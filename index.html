<!DOCTYPE html>
<html lang="zh" class="splash-active">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>废壳韵脚生成器 v1.7.7</title>
	<link rel="preconnect" href="https://unpkg.com" />
	<link rel="preconnect" href="https://cdnjs.cloudflare.com" />
	<link rel="preconnect" href="https://cdn.jsdelivr.net" />
	
	<!-- Preload Critical Resources -->
	<link rel="preload" href="styles/main.css" as="style" />
	<link rel="preload" href="scripts/app.js" as="script" />
	<link rel="preload" href="scripts/rhyme-engine.js" as="script" />
	<link rel="preload" href="scripts/dict-manager.js" as="script" />

	<link href="remixicon/remixicon.css" rel="stylesheet" />
	<link rel="stylesheet" href="styles/main.css">
	
	<!-- 启动屏幕内联关键样式 - 确保即时渲染 -->
	<style id="splash-critical-css">
		/* 启动时隐藏滚动条，防止闪现 */
		html.splash-active,
		html.splash-active body {
			overflow: hidden !important;
			height: 100% !important;
		}
		
		#splash-screen {
			position: fixed;
			inset: 0;
			z-index: 9999;
			background: linear-gradient(135deg, #1b0d22 0%, #0f0a15 100%);
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			transition: opacity 0.5s ease, visibility 0.5s ease;
		}
		
		#splash-screen.fade-out {
			opacity: 0;
			visibility: hidden;
			pointer-events: none;
		}
		
		.splash-logo {
			font-size: 28px;
			font-weight: 700;
			color: #e2e8f0;
			margin-bottom: 8px;
			opacity: 0;
			animation: splashFadeInUp 0.6s ease forwards;
			font-family: "DM Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
		}
		
		.splash-subtitle {
			font-size: 12px;
			color: #94a3b8;
			margin-bottom: 32px;
			opacity: 0;
			animation: splashFadeInUp 0.6s ease 0.1s forwards;
			font-family: "DM Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
		}
		
		.splash-progress-container {
			width: 200px;
			height: 4px;
			background: rgba(255, 255, 255, 0.1);
			border-radius: 2px;
			overflow: hidden;
			opacity: 0;
			animation: splashFadeInUp 0.6s ease 0.2s forwards;
		}
		
		#splash-progress-bar {
			width: 0%;
			height: 100%;
			background: linear-gradient(90deg, #7c3aed, #22d3ee);
			border-radius: 2px;
			transition: width 0.3s ease;
		}
		
		#splash-status {
			margin-top: 16px;
			font-size: 12px;
			color: #94a3b8;
			opacity: 0;
			animation: splashFadeInUp 0.6s ease 0.3s forwards;
			font-family: "DM Sans", "Segoe UI", system-ui, -apple-system, sans-serif;
		}
		
		@keyframes splashFadeInUp {
			from {
				opacity: 0;
				transform: translateY(10px);
			}
			to {
				opacity: 1;
				transform: translateY(0);
			}
		}
		
		/* 主内容初始隐藏，等待启动屏幕淡出 */
		.shell {
			opacity: 0;
			visibility: hidden;
		}
		
		/* 启动屏幕淡出后直接显示，不再播放动画 */
		.shell.ready {
			opacity: 1;
			visibility: visible;
		}
	</style>
</head>
<body>
	<!-- 启动屏幕 -->
	<div id="splash-screen">
		<div class="splash-logo">废壳韵脚生成器</div>
		<div class="splash-subtitle">©TRUEPEAK 2026</div>
		<div class="splash-progress-container">
			<div id="splash-progress-bar"></div>
		</div>
		<div id="splash-status">正在初始化...</div>
	</div>
	<!-- Vanta.js 3D 背景容器 -->
	<div id="vanta-bg"></div>
	
	<!-- 保留原有 blob 作为降级方案 -->
	<div class="bg-blob blob-1"></div>
	<div class="bg-blob blob-2"></div>
	<div class="bg-blob blob-3"></div>

	<div class="shell">
		<header>
			<h1>废壳韵脚生成器 v1.7.7</h1>
			<p class="credit">©TRUEPEAK 2026 - DEVELOPED BY DANJUAN </p>
			<p class="subtitle">输入词语，自动提取拼音、声调与韵母，生成每个字同声调同韵母的押韵字串。</p>
		</header>

		<main>
			<section class="panel">
				<div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; font-weight: 600; margin-bottom: 10px;">
					<label for="source">请输入要押韵的词语：</label>
					<a class="btn ghost small" href="custom.html"><i class="ri-file-list-3-line"></i>自定义词库</a>
				</div>
				<textarea id="source" placeholder="示例：废壳"></textarea>

				<div class="controls" style="display: flex; flex-direction: column; gap: 1px; margin-top: 12px; width: 100%;">
					<div style="display: flex; gap: 10px; flex-wrap: wrap;">
						<button class="btn" id="go">生成押韵</button>
						<button class="btn ghost small" id="loadDictBtn" title="从在线词库加载更多汉字">📚 加载词库</button>
					</div>
					<label class="small" style="margin-top: 10px;">韵脚宽松度</label>
					<div class="looseness-buttons" id="loosenessButtons" style="width: 100%;">
						<button class="looseness-btn active" data-value="0.0">严格</button>
						<button class="looseness-btn" data-value="0.5">中等</button>
						<button class="looseness-btn" data-value="1.0">最松</button>
					</div>
					<input type="hidden" id="looseness" value="0.0" />
					
					<div id="pingzeFilterContainer" style="margin-top: 10px; padding: 10px; background: rgba(124, 58, 237, 0.08); border-radius: 8px; border: 1px solid var(--border); width: 100%;">
						<label class="small" style="margin-bottom: 8px; display: block; text-align: center;">平仄过滤（尾字声调）</label>
						<div style="display: flex; gap: 16px; justify-content: center; flex-wrap: wrap;">
							<label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; margin: 0;">
								<input type="radio" name="pingze" value="all" checked /> <span>全部</span>
							</label>
							<label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; margin: 0;">
								<input type="radio" name="pingze" value="ping" /> <span>平</span>
							</label>
							<label style="display: flex; align-items: center; gap: 4px; cursor: pointer; font-size: 13px; margin: 0;">
								<input type="radio" name="pingze" value="ze" /> <span>仄</span>
							</label>
						</div>
					</div>
				</div>

				<div class="controls" style="display: flex; flex-direction: column; gap: 10px; margin-top: 16px; border-top: 1px solid var(--border); padding-top: 16px;">
					<div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
						<div style="display: flex; align-items: center; gap: 8px;">
							<input type="checkbox" id="aiMode" style="width: 18px; height: 18px; cursor: pointer;" />
							<label class="small" style="margin-bottom: 0; cursor: pointer;" for="aiMode"><i class="ri-robot-2-line"></i> AI 押韵模式 (Gemini API)</label>
						</div>
						<button class="btn ghost small" id="openAiSettings" title="AI 设置"><i class="ri-settings-3-line"></i></button>
					</div>
				</div>

				<div style="color:brown; font-size: small; font-weight: bold; text-align: center; margin-top: 12px;" id="dictWarning">*第一次使用前请先加载词库*</div>
				<div class="hint">- 严格：同韵同调  | 中等：韵母放宽 | 最松：忽略声调。</div>
				<div class="hint">- 生成结果的词是乱码的话，说明没有结果，调节韵脚宽松度即可。</div>
			</section>

			<section class="panel">
				<div style="font-weight: 600; margin-bottom: 14px;">生成结果</div>
				<div class="output" id="output"></div>
				<div class="badge-row" id="badges"></div>
			</section>
		</main>

		<section class="panel" style="margin: 0 32px 20px;">
			<label style="margin-bottom: 14px;">音调选择</label>
			<table>
				<thead>
					<tr>
						<th>原字</th>
						<th>拼音</th>
						<th>声调</th>
						<th>韵母/控制</th>
					</tr>
				</thead>
				<tbody id="detailBody"></tbody>
			</table>
		</section>

		<section class="panel" style="margin: 0 32px 20px;">
			<div id="matchedResults" style="padding: 12px; background: rgba(34, 211, 238, 0.05); border: 1px solid var(--border); border-radius: 8px; display: none;">
				<div style="font-weight: 600; margin-bottom: 8px; color: var(--accent-2);">更多匹配结果：</div>
				<div id="matchedResultsList" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
			</div>
			<div id="dictStatus" style="margin-top: 12px; padding: 8px 12px; background: rgba(124, 58, 237, 0.08); border-radius: 8px; font-size: 12px; color: var(--muted); display: none;">
				<span id="dictStatusText"></span>
			</div>
		</section>

		<div class="footer">词库基于雾凇拼音词库以及中华新华字典数据库以及清华大学开放中文词库，查询算法基于 pinyin-pro 解析。点击"📚 加载词库"可从在线词典获取7000+汉字，数据缓存在本地，可离线使用。</div>
	</div>

	<!-- AI Settings Modal -->
	<div class="modal-overlay" id="aiSettingsModal">
		<div class="modal settings-modal">
			<div class="modal-header">
				<h2><i class="ri-robot-2-line"></i> AI 押韵设置</h2>
				<button class="modal-close" id="closeAiSettings"><i class="ri-close-line"></i></button>
			</div>
			<div class="settings-body">
				<div class="settings-item">
					<label for="geminiApiKey">
						<span>Gemini API Key</span>
						<span class="badge-mini">必填</span>
					</label>
					<div class="input-wrapper">
						<i class="ri-key-2-line input-icon"></i>
						<input type="password" id="geminiApiKey" placeholder="输入您的 API Key" />
					</div>
					<p class="field-hint">需要 Google Gemini API Key 才能使用 AI 功能。</p>
				</div>

				<div class="settings-item">
					<label for="geminiModel">选择模型</label>
					<div class="select-wrapper">
						<i class="ri-cpu-line input-icon"></i>
						<select id="geminiModel">
							<option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
							<option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
							<option value="gemini-3-flash-preview">Gemini 3.0 Flash</option>
							<option value="gemini-3-pro-preview">Gemini 3.0 Pro</option>
						</select>
						<i class="ri-arrow-down-s-line select-arrow"></i>
					</div>
				</div>

				<div class="settings-item">
					<label for="geminiProxy">API 代理地址</label>
					<div class="input-wrapper">
						<i class="ri-global-line input-icon"></i>
						<input type="text" id="geminiProxy" placeholder="例如: http://127.0.0.1:7890" />
					</div>
					<p class="field-hint">如果无法直接访问 Google API，请配置代理地址。</p>
				</div>
			</div>
			<div class="modal-footer">
				<button class="btn" style="width: 100%;" id="saveAiSettings">保存设置</button>
			</div>
		</div>
	</div>

	<!-- Help Modal -->
	<button class="help-btn" id="helpTriggerBtn" title="使用说明">?</button>
	<div class="modal-overlay" id="helpModalOverlay">
		<div class="modal">
			<div class="modal-header">
				<h2>使用说明</h2>
				<button class="modal-close" id="helpCloseBtn">&times;</button>
			</div>
						<div class="modal-content">
				<h3> 基本功能</h3>
				<ul>
					<li><strong>加载词库：</strong>使用前请务必点击<strong>「加载词库」</strong>按钮</li>
					<li><strong>输入文字：</strong>在左侧输入框输入需要押韵的词语</li>
					<li><strong>生成押韵：</strong>点击<strong>「生成押韵」</strong>按钮，系统会自动分析并生成押韵词汇</li>
					<li><strong>韵脚宽松度：</strong>调节滑块可以放宽押韵条件，最宽松时可以选择显示平仄</li>
				</ul>
				
				<h3> 高级设置</h3>
				<ul>
					<li><strong>AI 押韵模式：</strong>启用后需要自行填入 Gemini API Key</li>
					<li><strong>支持的模型：</strong>目前 AI 模式暂时只支持 Gemini</li>
				</ul>
				
				<h3> 使用技巧</h3>
				<ul>
					<li>建议先从较严格的韵脚开始尝试，再逐步放宽条件</li>
					<li>可以多尝试不同的输入词语，探索更多押韵可能性</li>
					<li>AI 模式可以生成更有创意的押韵词汇，但需要联网使用</li>
				</ul>
				
				<h3>ℹ 关于</h3>
				<p>这是一个简单的中文押韵生成器，旨在帮助创作者寻找灵感。</p>
				<p style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border); text-align: center;">
					爷不肉，蛋卷制造 2026
				</p>
			</div>
		</div>
	</div>






























	
	<!-- 启动屏幕控制器 - 必须最先加载 -->
	<script src="scripts/splash-controller.js"></script>
	
	<!-- 核心本地脚本 - 同步加载确保依赖顺序 -->
	<script src="data.js"></script>
	<script src="scripts/db.js"></script>
	<script src="scripts/rhyme-engine.js"></script>
	<script src="scripts/dict-manager.js"></script>
	<script src="scripts/visual-effects.js"></script>
	<script src="scripts/app.js"></script>
	
	<script>
		// ========================================
		// 异步资源加载器
		// ========================================
		
		/**
		 * 异步加载单个脚本
		 * @param {string} src - 脚本 URL
		 * @returns {Promise}
		 */
		const loadScript = (src) => {
			return new Promise((resolve, reject) => {
				const script = document.createElement('script');
				script.src = src;
				script.onload = () => {
					console.log('[Loader] 已加载:', src);
					resolve();
				};
				script.onerror = () => reject(new Error(`加载失败: ${src}`));
				document.head.appendChild(script);
			});
		};
		
		/**
		 * Vanta.js 云雾背景初始化
		 */
		let vantaEffect = null;
		
		function initVantaBackground() {
			if (typeof VANTA === 'undefined') {
				console.warn('[Vanta] VANTA 未加载，使用降级背景');
				return false;
			}
			
			try {
				vantaEffect = VANTA.FOG({
					el: "#vanta-bg",
					mouseControls: true,
					touchControls: true,
					gyroControls: false,
					minHeight: 200.00,
					minWidth: 200.00,
					highlightColor: 0x7c3aed,
					midtoneColor: 0x2d1b4e,
					lowlightColor: 0x1b0d22,
					baseColor: 0x0f0a15,
					blurFactor: 0.6,
					speed: 1.5,
					zoom: 1.2
				});
				
				document.querySelectorAll('.bg-blob').forEach(blob => {
					blob.style.opacity = '0';
				});
				
				console.log('[Vanta] 云雾背景初始化成功');
				return true;
			} catch (e) {
				console.error('[Vanta] 初始化失败:', e);
				return false;
			}
		}
		
		/**
		 * 初始化 GSAP 动画
		 */
		function initGSAPAnimations() {
			if (typeof gsap === 'undefined') {
				console.warn('[GSAP] GSAP 未加载');
				return;
			}
			
			console.time('gsap-init');
			gsap.registerPlugin(ScrollTrigger);
			
			// 如果 Vanta 加载失败，保留 blob 动画作为降级
			if (!vantaEffect) {
				gsap.to(".blob-1", { x: "20%", y: "20%", duration: 8, repeat: -1, yoyo: true, ease: "sine.inOut" });
				gsap.to(".blob-2", { x: "-20%", y: "-20%", duration: 10, repeat: -1, yoyo: true, ease: "sine.inOut", delay: 1 });
				gsap.to(".blob-3", { x: "15%", y: "-15%", scale: 1.2, duration: 12, repeat: -1, yoyo: true, ease: "sine.inOut", delay: 2 });
			}
			
			// AutoAnimate integration
			if (typeof autoAnimate !== 'undefined') {
				const outputContainer = document.getElementById('output');
				const badgesContainer = document.getElementById('badges');
				const matchedList = document.getElementById('matchedResultsList');
				
				if (outputContainer) autoAnimate(outputContainer);
				if (badgesContainer) autoAnimate(badgesContainer);
				if (matchedList) autoAnimate(matchedList);
			}
			
			// 结果动画触发器
			window.triggerResultAnimation = () => {
				gsap.fromTo("#output", { opacity: 0.5, y: 5 }, { opacity: 1, y: 0, duration: 0.4 });
			};
			
			console.timeEnd('gsap-init');
		}
		
		/**
		 * 初始化模态框事件
		 */
		function initModalEvents() {
			const helpBtn = document.getElementById('helpTriggerBtn');
			const helpModal = document.getElementById('helpModalOverlay');
			const helpClose = document.getElementById('helpCloseBtn');
			const closeAiSettings = document.getElementById('closeAiSettings');
			
			if (helpBtn && helpModal) {
				helpBtn.onclick = () => helpModal.classList.add('active');
			}
			if (helpClose && helpModal) {
				helpClose.onclick = () => helpModal.classList.remove('active');
			}
			if (closeAiSettings) {
				closeAiSettings.onclick = () => {
					document.getElementById('aiSettingsModal').classList.remove('active');
				};
			}
		}
		
		/**
		 * 显示主界面
		 * 注意：不再播放入场动画，直接显示最终状态，避免闪现
		 */
		function showMainContent() {
			const shell = document.querySelector('.shell');
			if (shell) {
				shell.classList.add('ready');
			}
			
			// 设置元素为可见状态，但不播放动画
			if (typeof gsap !== 'undefined') {
				gsap.set(".shell, .panel", {
					visibility: "visible",
					opacity: 1,
					y: 0
				});
			}
		}
		
		// ========================================
		// 分阶段异步加载主流程
		// ========================================
		
		/**
		 * 检查是否需要显示启动屏幕
		 * 如果是从其他页面返回的，跳过启动屏幕
		 */
		function shouldShowSplash() {
			// 检查 sessionStorage 中是否有初始化标记
			const hasInitialized = sessionStorage.getItem('APP_INITIALIZED');
			return !hasInitialized;
		}
		
		/**
		 * 快速初始化（跳过启动屏幕）
		 * 用于从其他页面返回时
		 */
		async function quickInitialize() {
			console.time('quick-init');
			
			// 立即隐藏启动屏幕
			const splash = document.getElementById('splash-screen');
			if (splash) splash.remove();
			
			// 移除 splash-active 类
			document.documentElement.classList.remove('splash-active');
			
			// 显示主界面
			const shell = document.querySelector('.shell');
			if (shell) shell.classList.add('ready');
			
			try {
				// 快速加载必要资源
				await loadScript('https://cdn.jsdelivr.net/npm/pinyin-pro@3.27.0/dist/index.js');
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js');
				await loadScript('https://cdn.jsdelivr.net/npm/vanta@0.5.24/dist/vanta.fog.min.js');
				initVantaBackground();
				
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js');
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js');
				await loadScript('https://cdn.jsdelivr.net/npm/@formkit/auto-animate@0.8.2/index.min.js');
				initGSAPAnimations();
				
				// 设置元素为可见状态
				if (typeof gsap !== 'undefined') {
					gsap.set(".shell, .panel", {
						visibility: "visible",
						opacity: 1,
						y: 0
					});
				}
				
				initModalEvents();
				console.timeEnd('quick-init');
			} catch (error) {
				console.error('[Quick Init] 初始化失败:', error);
			}
		}
		
		async function initializeApp() {
			// 检查是否需要显示启动屏幕
			if (!shouldShowSplash()) {
				console.log('[Init] 检测到已初始化，跳过启动屏幕');
				await quickInitialize();
				return;
			}
			
			console.time('total-init');
			
			try {
				// 阶段 1: CSS 已加载
				SplashController.updateProgress('CSS_LOADED');
				await new Promise(r => setTimeout(r, 100)); // 让进度条动画显示
				
				// 阶段 2: 核心脚本已加载（同步脚本已执行）
				SplashController.updateProgress('CORE_SCRIPTS');
				await new Promise(r => setTimeout(r, 100));
				
				// 阶段 3: 加载 pinyin-pro
				await loadScript('https://cdn.jsdelivr.net/npm/pinyin-pro@3.27.0/dist/index.js');
				SplashController.updateProgress('PINYIN_LOADED');
				
				// 阶段 4: 加载 Three.js + Vanta.js
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js');
				await loadScript('https://cdn.jsdelivr.net/npm/vanta@0.5.24/dist/vanta.fog.min.js');
				initVantaBackground();
				SplashController.updateProgress('VANTA_LOADED');
				
				// 阶段 5: 加载 GSAP + AutoAnimate
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js');
				await loadScript('https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js');
				await loadScript('https://cdn.jsdelivr.net/npm/@formkit/auto-animate@0.8.2/index.min.js');
				initGSAPAnimations();
				SplashController.updateProgress('GSAP_LOADED');
				
				// 阶段 6: 词库加载（由 app.js 中的 DictManager 处理）
				// 这里只是更新进度，实际加载在 app.js 的 init 中
				SplashController.updateProgress('DICT_LOADED');
				
				// 完成
				SplashController.updateProgress('COMPLETE');
				
				// 初始化模态框事件
				initModalEvents();
				
				// 标记应用已初始化（在当前会话中）
				sessionStorage.setItem('APP_INITIALIZED', 'true');
				
				// 延迟隐藏启动屏幕，让用户看到 100%
				await new Promise(r => setTimeout(r, 300));
				
				// 隐藏启动屏幕并显示主界面
				SplashController.hide(() => {
					showMainContent();
					console.timeEnd('total-init');
				});
				
			} catch (error) {
				console.error('[Init] 初始化失败:', error);
				SplashController.showError('加载失败: ' + error.message);
			}
		}
		
		// 窗口大小变化时重新调整 Vanta
		window.addEventListener('resize', () => {
			if (vantaEffect) {
				vantaEffect.resize();
			}
		});
		
		// DOM 就绪后开始异步加载
		document.addEventListener('DOMContentLoaded', initializeApp);
	</script>
</body>
</html>
